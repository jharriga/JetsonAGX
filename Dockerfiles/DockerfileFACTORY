# Reinstall NVIDIA AGX Factory JetPack software (Ubuntu 18.04)
# Requires AGX already be in forced recovery mode
#   podman build --tag factory -f ./DockerfileFACTORY
#   podman run --rm -it -v /dev:/dev --device-cgroup-rule='c 188:* rmw' --privileged factory
# *Sample output*
# [ 324.0653 ] 
# *** The target t186ref has been flashed successfully. ***
# Reset the board to boot from internal eMMC.
#########################################################
FROM ubuntu:18.04

# install usbutils, git and qemu-user-static 
# binfmt-support, python3, xdd
RUN apt-get update -y && apt-get install -y \ 
  usbutils \
  wget \
  qemu-user-static \
  binfmt-support \
  python3\
  xxd \
  cpio \
  binutils \
  openssh-client \
  libgetopt-complete-perl

# Download NVIDIA packages
# To reduce image size moved these to installFACTORY.sh
##RUN wget https://developer.nvidia.com/embedded/l4t/r32_release_v5.1/r32_release_v5.1/t186/tegra186_linux_r32.5.1_aarch64.tbz2
##RUN wget https://developer.nvidia.com/embedded/l4t/r32_release_v5.1/r32_release_v5.1/t186/tegra_linux_sample-root-filesystem_r32.5.1_aarch64.tbz2

# Script verifies AGX is in RCM, then downloads and installs NVIDIA Factory Software
ADD installFACTORY.sh /
RUN chmod +x /installFACTORY.sh

# Required for flash.sh which is called within ./installFACTORY.sh 
ln -s /usr/bin/python3 /usr/bin/python
ENV USER=root

# should this be ENTRYPOINT or CMD?
CMD echo "Verifying AGX is in forced recovery mode" && \
  echo " and then installing NVIDIA factory software" && \
  cd / && \
  /installFACTORY.sh
